<p-toast></p-toast>

<section class="luxo-checkout-container fadein">
  <header class="checkout-header">
    <button class="btn-back" (click)="voltarParaHistorico()">
      <i class="pi pi-arrow-left"></i> VOLTAR PARA O HISTÓRICO
    </button>
    <div class="header-content">
      <span class="category-tag">Concierge Digital</span>
      <h1>Finalização de Pedido VIP</h1>
    </div>
  </header>

  <form [formGroup]="pedidoForm" (ngSubmit)="finalizarVenda()">
    <div class="checkout-grid">

      <div class="selection-area">

        <div class="checkout-card">
          <h3><i class="pi pi-user"></i> SELECIONAR CLIENTE VIP</h3>
          <p-autoComplete
            formControlName="cliente"
            [suggestions]="clientesFiltrados"
            (completeMethod)="filtrarClientes($event)"
            field="nome"
            [dropdown]="true"
            placeholder="Comece a digitar o nome da cliente..."
            styleClass="luxo-autocomplete"
            [forceSelection]="true">
            <ng-template let-cliente pTemplate="item">
              <div class="flex justify-content-between align-items-center w-full">
                <span>{{ cliente.nome }}</span>
                <span class="text-xs gold-tag">{{ cliente.perfil }}</span>
              </div>
            </ng-template>
          </p-autoComplete>
        </div>

        <div class="checkout-card">
          <div class="card-header-flex">
            <h3><i class="pi pi-shopping-bag"></i> ITENS DA CURADORIA</h3>
            <p-dropdown
              [options]="sandaliasDisponiveis"
              optionLabel="modelo"
              placeholder="ADICIONAR CALÇADO À VENDA"
              (onChange)="adicionarItem($event.value)"
              styleClass="luxo-dropdown-add"
              [filter]="true">
              <ng-template let-s pTemplate="item">
                <div class="product-dropdown-item">
                  <div class="flex flex-column">
                    <span class="font-bold">{{ s.modelo }}</span>
                    <small class="text-600">SKU: {{ s.sku }}</small>
                  </div>
                  <span class="stock-badge" [class.low-stock]="s.estoque < 3">
                    {{ s.estoque }} DISP.
                  </span>
                </div>
              </ng-template>
            </p-dropdown>
          </div>

          <p-table [value]="itens.controls" styleClass="p-datatable-sm" *ngIf="itens.length > 0">
            <ng-template pTemplate="header">
              <tr>
                <th>PRODUTO</th>
                <th class="text-center">QUANTIDADE</th>
                <th class="text-right">UNITÁRIO</th>
                <th class="text-right">SUBTOTAL</th>
                <th></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-item let-i="index">
              <tr [formGroupName]="i">
                <td>
                  <div class="product-info">
                    <span class="sku">{{ item.value.sandalia.sku }}</span>
                    <span class="modelo">{{ item.value.sandalia.modelo }}</span>
                  </div>
                </td>
                <td>
                  <div class="stock-control-wrapper">
                    <p-inputNumber
                      formControlName="quantidade"
                      [showButtons]="true"
                      buttonLayout="horizontal"
                      spinnerMode="horizontal"
                      decrementButtonClass="p-button-text"
                      incrementButtonClass="p-button-text"
                      incrementButtonIcon="pi pi-plus"
                      decrementButtonIcon="pi pi-minus"
                      [min]="1"
                      [max]="item.value.sandalia.estoque"
                      (onInput)="calcularTotal()">
                    </p-inputNumber>
                    <span class="stock-info">Estoque: {{ item.value.sandalia.estoque }}</span>
                  </div>
                </td>
                <td class="text-right">{{ item.value.precoVendaNoAto | currency:'BRL' }}</td>
                <td class="text-right font-bold">{{ (item.value.precoVendaNoAto * item.value.quantidade) | currency:'BRL' }}</td>
                <td class="text-center">
                  <button type="button" class="btn-remove" (click)="removerItem(i)">
                    <i class="pi pi-trash"></i>
                  </button>
                </td>
              </tr>
            </ng-template>
          </p-table>

          <div *ngIf="itens.length === 0" class="empty-cart">
            Nenhum item selecionado para esta transação.
          </div>
        </div>
      </div>

      <aside class="summary-card">
        <h3>RESUMO DO PEDIDO</h3>

        <div class="summary-row">
          <span>Itens na curadoria</span>
          <span>{{ itens.length }}</span>
        </div>
        <div class="summary-row">
          <span>Embalagem Especial</span>
          <span class="free">CORTESIA VIP</span>
        </div>
        <div class="summary-row">
          <span>Envio por Concierge</span>
          <span class="free">GRATUITO</span>
        </div>

        <hr class="divider">

        <div class="total-row">
          <span class="luxo-label-text">VALOR TOTAL DO INVESTIMENTO</span>
          <span class="amount">{{ pedidoForm.get('valorTotal')?.value | currency:'BRL' }}</span>
        </div>

        <button type="submit" class="btn-finalize" [disabled]="pedidoForm.invalid || itens.length === 0">
          FINALIZAR VENDA VIP
        </button>

        <button type="button" class="btn-reset" (click)="resetarFormulario()">
          LIMPAR FORMULÁRIO
        </button>

        <p class="disclaimer">
          Ao finalizar, o estoque será abatido automaticamente e os pontos de fidelidade serão creditados à cliente.
        </p>
      </aside>

    </div>
  </form>
</section>
